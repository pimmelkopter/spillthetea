<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spill The Tea</title>
    <style>
        :root {
            /* Gradient Theme (Default) */
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --header-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --btn-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --btn-secondary-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --btn-danger-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            --bubble-right-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            
            /* Monochrom Theme */
            --bg-mono: #f5f5f5;
            --header-mono: #333;
            --btn-mono: #666;
            --btn-secondary-mono: #999;
            --btn-danger-mono: #777;
            --bubble-right-mono: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        body.monochrom {
            background: var(--bg-mono);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: var(--header-gradient);
            color: white;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative; /* For theme switch positioning */
        }

        body.monochrom .header {
            background: var(--header-mono);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header h1:hover {
            transform: scale(1.02);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .theme-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.9rem;
        }

        .theme-switch input[type="checkbox"] {
            appearance: none;
            width: 50px;
            height: 25px;
            background: rgba(255,255,255,0.3);
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-switch input[type="checkbox"]:before {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .theme-switch input[type="checkbox"]:checked:before {
            transform: translateX(25px);
        }

        .main-content {
            padding: 0;
        }

        /* alle direkten Kinder bekommen 30px Padding */
        .main-content > * {
            padding: 30px;
        }

        /* aber .chat-preview nicht */
        .main-content > .chat-preview {
            padding: 0;
        }

        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .control-btn {
            background: rgba(79, 172, 254, 0.1);
            color: #4facfe;
            border: 1px solid #4facfe;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #4facfe;
            color: white;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .message-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-form-row {
            display: flex;
            gap: 10px;
        }

        .message-form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .post-button-row {
            display: flex;
            justify-content: center;
        }

        .btn {
            background: var(--btn-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        body.monochrom .btn {
            background: var(--btn-mono);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--btn-secondary-gradient);
            color: #333;
        }

        body.monochrom .btn-secondary {
            background: var(--btn-secondary-mono);
            color: white;
        }

        .btn-danger {
            background: var(--btn-danger-gradient);
            color: #333;
        }

        body.monochrom .btn-danger {
            background: var(--btn-danger-mono);
            color: white;
        }

        .person-manager {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .person-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .person-tag {
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #e1e5e9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .person-tag.editable {
            cursor: pointer;
        }

        .person-tag.editable:hover {
            border-color: #4facfe;
        }

        .chat-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 30px;
            min-height: 200px;
            overflow: hidden;
        }

        .chat-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            padding: 20px 20px 10px 20px;
            border-bottom: 2px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-title:hover {
            background: rgba(79, 172, 254, 0.1);
        }

        .chat-title.active {
            background: rgba(79, 172, 254, 0.2);
        }

        .messages-container {
            width: 100%;
            padding: 20px 30px;
        }

        .message {
            display: flex;
            margin-bottom: 15px;
            animation: messageSlide 0.3s ease-out;
            flex-direction: column;
            position: relative;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.right {
            align-items: flex-end;
        }

        .message.left {
            align-items: flex-start;
        }

        .message.comment {
            align-items: center;
        }

        .message-controls {
            display: none;
            gap: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .message:hover .message-controls {
            display: flex;
        }

        .message.right .message-controls {
            justify-content: flex-end;
        }

        .message.comment .message-controls {
            justify-content: center;
        }

        .message-control-btn {
            background: rgba(0,0,0,0.1);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .message-control-btn:hover {
            background: rgba(0,0,0,0.2);
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.left .message-bubble {
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.right .message-bubble {
            background: var(--bubble-right-gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.comment .message-bubble {
            background: #f0f0f0;
            color: #666;
            max-width: 90%;
            border-radius: 12px;
            font-style: italic;
            text-align: center;
            border: 1px solid #ddd;
        }

        body.monochrom .message.right .message-bubble {
            background: var(--bubble-right-mono);
        }

        body.monochrom .message.comment .message-bubble {
            background: #e8e8e8;
            color: #555;
        }

        .message-info {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        .message-sender {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message.left .message-sender {
            color: #666;
        }

        .message.right .message-sender {
            color: #4facfe;
            text-align: right;
        }

        body.monochrom .message.right .message-sender {
            color: #333;
        }

        .message-image {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .share-options {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }

        .share-options.active {
            display: block;
        }

        .share-options.ongoing-mode .share-form {
            display: none;
        }

        .share-options.ongoing-mode .ongoing-form {
            display: block;
        }

        .ongoing-form {
            display: none;
        }

        .edit-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            font-style: italic;
            color: #856404;
        }

        .edit-link-info {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .edit-link-info.active {
            display: block;
        }

        .file-upload {
            margin-top: 10px;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload label {
            display: inline-block;
            padding: 8px 16px;
            background: #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload label:hover {
            background: #d1d5d9;
        }

        .ongoing-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .tooltip {
            position: relative;
            cursor: help;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            background: #999;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            margin-left: 4px;
            vertical-align: super;
            line-height: 1;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            font-weight: normal;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal h3 {
            margin: 20px 0 10px 0;
            color: #4facfe;
        }

        .modal p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #555;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .theme-switch {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }

            .main-content > * {
                padding: 20px;
            }

            .main-content > .chat-preview {
                padding: 0;
            }

            .messages-container {
                padding: 20px 15px;
            }

            .message-form-row {
                flex-direction: column;
                gap: 15px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                padding: 15px 24px;
            }

            .message-bubble {
                max-width: 85%;
            }

            .message.comment .message-bubble {
                max-width: 95%;
            }

            .top-controls {
                flex-direction: column;
                gap: 10px;
            }

            .modal-content {
                padding: 20px;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="theme-switch">
                <span>Gradient</span>
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <span>Monochrom</span>
            </div>
            <h1 onclick="window.location.href='/'">☕ Spill The Tea</h1>
            <p>Eine Chat Share App von @pimmelkopter</p>
        </div>

        <div class="main-content">
            <!-- Top Controls -->
            <div class="top-controls">
                <button class="control-btn" onclick="startNewTea()">🆕 New Tea</button>
                <button class="control-btn" onclick="showFAQ()">❓ FAQ</button>
            </div>

            <!-- Chat Creation Form -->
            <div class="form-section">
                <div class="form-group">
                    <label for="chatTitle">Chat Titel (optional)</label>
                    <input type="text" id="chatTitle" placeholder="z.B. Gespräch mit Anna">
                </div>

                <!-- Person Manager -->
                <div class="person-manager">
                    <label>Gesprächspartner verwalten</label>
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="showNamesToggle" onchange="toggleShowNames()">
                            Namen in Chat-Bubbles anzeigen
                        </label>
                    </div>
                    <div class="person-list" id="personList">
                        <div class="person-tag editable" data-person="you">
                            <span>Du (you)</span>
                            <button onclick="editPerson('you')" style="background:none;border:none;cursor:pointer;">✏️</button>
                        </div>
                        <div class="person-tag editable" data-person="them">
                            <span>Them</span>
                            <button onclick="editPerson('them')" style="background:none;border:none;cursor:pointer;">✏️</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <input type="text" id="newPersonName" placeholder="Neue Person hinzufügen">
                        </div>
                        <button class="btn btn-secondary" onclick="addPerson()">Hinzufügen</button>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="message-form">
                    <div class="form-group">
                        <label for="messageText">Nachricht</label>
                        <textarea id="messageText" placeholder="Schreibe eine Nachricht..."></textarea>
                    </div>
                    
                        <div class="file-upload">
                            <label for="messageImage">📎 Bild anhängen</label>
                            <input type="file" id="messageImage" accept="image/*">
                        </div>
                    
                    <div class="message-form-row">
                    <div class="form-group">
                        <label for="messageSender">Von</label>
                        <select id="messageSender">
                            <option value="you">Du (you)</option>
                            <option value="them">Them</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="messageTime">Zeit (optional)</label>
                        <input type="time" id="messageTime">
                    </div>
                    <div class="form-group">
                        <label for="messageDate">Datum (optional)</label>
                        <input type="date" id="messageDate">
                    </div>
                </div>
                    
                    <div class="post-button-row">
                <button class="btn" onclick="addMessage()" id="postBtn">Post</button>
                    </div>
                </div>
            </div>

            <!-- Chat Preview -->
            <div class="chat-preview" id="chatPreview">
                <div id="messagesContainer" class="messages-container"></div>
            </div>

            <!-- Edit Mode Notice -->
            <div id="editNotice" class="edit-notice" style="display: none;">
                Ein bearbeiteter Chat muss immer mit einem neuen Link geteilt werden
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="scrollToMessageForm()">Add Message</button>
                <button class="btn btn-secondary" onclick="addComment()">Add Comment</button>
                <button class="btn btn-secondary" onclick="addNewChat()">Add Chat</button>
                <button class="btn" onclick="toggleShareOptions()" id="shareToggleBtn">Spill the Tea ☕</button>
            </div>

            <!-- Share Options -->
            <div class="share-options" id="shareOptions">
                <h3>Sharing Optionen</h3>
                
                <!-- Normal Share Form -->
                <div class="share-form" id="shareForm">
                <div class="form-group">
                    <label for="shareExpiry">Verfallszeit</label>
                    <select id="shareExpiry">
                        <option value="never">Niemals</option>
                        <option value="1hour">1 Stunde</option>
                        <option value="1day">1 Tag</option>
                        <option value="1week">1 Woche</option>
                        <option value="1month">1 Monat</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shareViews">Max. Aufrufe</label>
                    <select id="shareViews">
                        <option value="unlimited">Unbegrenzt</option>
                        <option value="1">1 Aufruf</option>
                        <option value="5">5 Aufrufe</option>
                        <option value="10">10 Aufrufe</option>
                        <option value="50">50 Aufrufe</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sharePassword">Passwort (optional)</label>
                    <input type="password" id="sharePassword" placeholder="Passwort für den Link">
                </div>
                    
                    <div class="ongoing-checkbox">
                        <input type="checkbox" id="ongoingCheckbox">
                        <label for="ongoingCheckbox">Der Tea geht vielleicht weiter?</label>
                        <span class="tooltip" data-tooltip="Wenn du nach dem teilen weiter nachrichten hinzufügen willst">?</span>
                    </div>
                
                <button class="btn" onclick="shareChat()" id="shareBtn">Link erstellen 🔗</button>
                </div>

                <!-- Ongoing Update Form -->
                <div class="ongoing-form" id="ongoingForm">
                    <div class="form-group">
                        <label for="ongoingExpiry">Verfallszeit</label>
                        <select id="ongoingExpiry">
                            <option value="never">Niemals</option>
                            <option value="1hour">1 Stunde</option>
                            <option value="1day">1 Tag</option>
                            <option value="1week">1 Woche</option>
                            <option value="1month">1 Monat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ongoingViews">Max. Aufrufe</label>
                        <select id="ongoingViews">
                            <option value="unlimited">Unbegrenzt</option>
                            <option value="1">1 Aufruf</option>
                            <option value="5">5 Aufrufe</option>
                            <option value="10">10 Aufrufe</option>
                            <option value="50">50 Aufrufe</option>
                        </select>
                    </div>
                    
                    <div class="edit-notice">
                        Wenn du Verfallszeit oder Max Aufrufe änderst werden die Zähler zurückgesetzt und zählen wieder ab jetzt.
                    </div>
                    
                    <button class="btn" onclick="updateTea()" id="updateBtn">Update the Tea ☕</button>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 8px;">
                        <strong>Dein Link:</strong>
                        <input type="text" id="ongoingShareLink" readonly style="margin-top: 8px; font-family: monospace;">
                        <button onclick="copyToClipboard('ongoingShareLink')" style="margin-top: 8px;" class="btn btn-secondary">Kopieren</button>
                    </div>
                </div>

                <div id="shareResult" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 8px; display: none;">
                    <strong>Dein Link:</strong>
                    <input type="text" id="shareLink" readonly style="margin-top: 8px; font-family: monospace;">
                    <button onclick="copyToClipboard('shareLink')" style="margin-top: 8px;" class="btn btn-secondary">Kopieren</button>
                </div>
                <div class="edit-link-info" id="editLinkInfo">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong id="editChatTitle">Chat Titel</strong><br>
                            <small>Edit Link:</small> <code id="editLink">...</code><br>
                            <small>Edit Passwort:</small> <code id="editPassword">...</code><br>
                            <small>Läuft ab:</small> <span id="editExpiry">...</span>
                        </div>
                        <button onclick="copyEditInfo()" class="btn btn-secondary" style="margin-left: 10px;">Kopieren</button>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            <div id="alerts"></div>
        </div>
    </div>

    <!-- FAQ Modal -->
    <div class="modal" id="faqModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeFAQ()">&times;</button>
            <h2>☕ Spill The Tea - FAQ</h2>
            
            <h3>Wofür ist diese App?</h3>
            <p>Du willst ein Gespräch mit deinen Freunden teilen ohne tausend Screenshots? Das geht hier! Erstelle authentisch aussehende Chat-Verläufe und teile sie mit einem einfachen Link.</p>
            
            <h3>Wie funktioniert es?</h3>
            <p>Füge Gesprächspartner hinzu, schreibe Nachrichten mit Zeitstempeln und Bildern, und teile dann den Chat oder mehrere Chats zusammen. Du kannst auch Kommentare hinzufügen oder ongoing Chats erstellen, die weiter bearbeitet werden können.</p>
            
            <h3>Wer kann es sehen?</h3>
            <p>Du kannst beim Teilen einstellen wie oft der Link geklickt werden kann, ein Ablaufdatum setzen oder ein Passwort einstellen. Die Daten werden über eine sichere Verbindung (HTTPS) übertragen. Passwörter werden verschlüsselt gespeichert, aber die Chat-Inhalte sind für Server-Administratoren technisch einsehbar.</p>
            
            <h3>Was sind Edit-Links?</h3>
            <p>Beim Erstellen eines Chats bekommst du automatisch einen Edit-Link mit zufälligem Passwort. Damit kannst du den Chat später bearbeiten und einen neuen Sharing-Link erstellen.</p>
            
            <h3>Was bedeutet "ongoing"?</h3>
            <p>Ongoing Chats können über den Edit-Link kontinuierlich erweitert werden, ohne dass ein neuer Link erstellt werden muss. Der Edit-Link läuft erst nach 3 Monaten ab.</p>
        </div>
    </div>

    <script>
        // Global state
        let chats = [{ title: '', messages: [], persons: { you: 'Du', them: 'Them' }, showNames: false }];
        let currentChatIndex = 0;
        let editingMessageIndex = -1;
        let isMonochrom = false;
        let isEditMode = false;
        let isOngoingMode = false;
        let currentEditUrl = null;
        let currentEditPassword = null;

        // Sanitization function
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // Local storage management
        function saveToLocalStorage() {
            const state = {
                chats,
                currentChatIndex,
                isMonochrom
            };
            localStorage.setItem('spillthetea_editor_state', JSON.stringify(state));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('spillthetea_editor_state');
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    chats = state.chats || [{ title: '', messages: [], persons: { you: 'Du', them: 'Them' }, showNames: false }];
                    currentChatIndex = state.currentChatIndex || 0;
                    isMonochrom = state.isMonochrom || false;
                    
                    document.getElementById('themeToggle').checked = isMonochrom;
                    if (isMonochrom) document.body.classList.add('monochrom');
                    
                    updateCurrentChatUI();
                    updatePreview();
                } catch (e) {
                    console.log('Could not load saved state:', e);
                }
            }
        }

        function clearLocalStorage() {
            localStorage.removeItem('spillthetea_editor_state');
        }

        // Check if this is edit mode
        function checkEditMode() {
            const path = window.location.pathname;
            const editMatch = path.match(/\/edit\/([a-z0-9]+)/);
            if (editMatch) {
                isEditMode = true;
                loadEditChat(editMatch[1]);
            }
        }

        async function loadEditChat(editUrl) {
            try {
                const password = prompt('Edit-Passwort eingeben:');
                if (!password) {
                    window.location.href = '/';
                    return;
                }

                const response = await fetch(`/api/edit/${editUrl}?password=${encodeURIComponent(password)}`);
                const result = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Falsches Passwort!');
                        window.location.href = '/';
                        return;
                    } else {
                        alert('Fehler beim Laden: ' + result.error);
                        window.location.href = '/';
                        return;
                    }
                }

                // Load chat data
                chats = result.data.chats;
                isMonochrom = result.data.theme === 'monochrom';
                isOngoingMode = result.isOngoing;
                currentEditUrl = editUrl;
                currentEditPassword = password;
                
                document.getElementById('themeToggle').checked = isMonochrom;
                if (isMonochrom) document.body.classList.add('monochrom');
                
                updateCurrentChatUI();
                updatePreview();
                
                // Show edit notice above action buttons
                document.getElementById('editNotice').style.display = 'block';
                
                // Handle ongoing mode
                if (isOngoingMode) {
                    document.getElementById('shareToggleBtn').style.display = 'none';
                    document.getElementById('shareOptions').classList.add('active', 'ongoing-mode');
                    
                    // Populate ongoing form with current values
                    if (result.expiresAt) {
                        const expiry = getExpiryType(result.expiresAt);
                        document.getElementById('ongoingExpiry').value = expiry;
                    }
                    document.getElementById('ongoingViews').value = result.maxViews === -1 ? 'unlimited' : result.maxViews.toString();
                    
                    // Set the share link
                    const shareUrl = `${window.location.origin}/chat/${editUrl}`;
                    document.getElementById('ongoingShareLink').value = shareUrl;
                    
                    showAlert('Ongoing Chat geladen! Du kannst die Einstellungen anpassen und Nachrichten hinzufügen.', 'success');
                } else {
                showAlert('Chat erfolgreich geladen! Vergiss nicht, nach Änderungen einen neuen Link zu erstellen.', 'success');
                }
            } catch (error) {
                console.error('Load edit chat error:', error);
                alert('Verbindungsfehler');
                window.location.href = '/';
            }
        }

        function getExpiryType(expiresAt) {
            const now = new Date();
            const expiry = new Date(expiresAt);
            const diff = expiry.getTime() - now.getTime();
            const hours = diff / (1000 * 60 * 60);
            
            if (hours <= 1) return '1hour';
            if (hours <= 24) return '1day';
            if (hours <= 168) return '1week';
            if (hours <= 720) return '1month';
            return 'never';
        }

        // Theme functions
        function toggleTheme() {
            isMonochrom = document.getElementById('themeToggle').checked;
            document.body.classList.toggle('monochrom', isMonochrom);
            saveToLocalStorage();
        }

        // Modal functions
        function showFAQ() {
            document.getElementById('faqModal').classList.add('active');
        }

        function closeFAQ() {
            document.getElementById('faqModal').classList.remove('active');
        }

        // Utility functions
        function showAlert(message, type = 'error') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function setLoading(elementId, loading) {
            const element = document.getElementById(elementId);
            if (loading) {
                element.disabled = true;
                element.innerHTML = '<span class="loading"></span> Loading...';
            } else {
                element.disabled = false;
                const originalText = element.id === 'shareBtn' ? 'Link erstellen 🔗' : 
                                   element.id === 'updateBtn' ? 'Update the Tea ☕' : 'Post';
                element.innerHTML = originalText;
            }
        }

        function smoothScrollTo(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function scrollToMessageForm() {
            const messageText = document.getElementById('messageText');
            if (messageText) {
                messageText.scrollIntoView({ behavior: 'smooth', block: 'center' });
                messageText.focus();
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container.children.length > 0) {
                container.lastElementChild.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Chat management functions
        function getCurrentPersons() {
            return chats[currentChatIndex].persons;
        }

        function getCurrentShowNames() {
            return chats[currentChatIndex].showNames || false;
        }

        function updateCurrentChatUI() {
            const currentChat = chats[currentChatIndex];
            document.getElementById('chatTitle').value = sanitizeInput(currentChat.title || '');
            document.getElementById('showNamesToggle').checked = currentChat.showNames || false;
            updatePersonList();
            updatePersonSelect();
        }

        function switchToChat(index) {
            // Save current state
            saveCurrentChatState();
            
            // Switch to new chat
            currentChatIndex = index;
            updateCurrentChatUI();
            updatePreview();
            saveToLocalStorage();
        }

        function saveCurrentChatState() {
            const currentChat = chats[currentChatIndex];
            currentChat.title = sanitizeInput(document.getElementById('chatTitle').value.trim());
            currentChat.persons = getCurrentPersons();
            currentChat.showNames = document.getElementById('showNamesToggle').checked;
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const result = await response.json();
                return result.url;
            } catch (error) {
                console.error('Upload error:', error);
                throw error;
            }
        }

        function updatePersonSelect() {
            const select = document.getElementById('messageSender');
            select.innerHTML = '';
            
            Object.entries(getCurrentPersons()).forEach(([key, name]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key === 'you' ? `${name} (you)` : name;
                select.appendChild(option);
            });
            
            // Add comment option at the bottom
            const commentOption = document.createElement('option');
            commentOption.value = 'comment';
            commentOption.textContent = 'Comment';
            select.appendChild(commentOption);
        }

        function addPerson() {
            const input = document.getElementById('newPersonName');
            const name = sanitizeInput(input.value.trim());
            
            if (name) {
                const key = name.toLowerCase().replace(/\s+/g, '');
                getCurrentPersons()[key] = name;
                input.value = '';
                updatePersonList();
                updatePersonSelect();
                saveToLocalStorage();
            }
        }

        function editPerson(key) {
            const currentPersons = getCurrentPersons();
            const newName = prompt('Neuer Name:', currentPersons[key]);
            if (newName && newName.trim()) {
                currentPersons[key] = sanitizeInput(newName.trim());
                updatePersonList();
                updatePersonSelect();
                saveToLocalStorage();
            }
        }

        function toggleShowNames() {
            chats[currentChatIndex].showNames = document.getElementById('showNamesToggle').checked;
            updatePreview();
            saveToLocalStorage();
        }

        function updatePersonList() {
            const container = document.getElementById('personList');
            container.innerHTML = '';
            
            Object.entries(getCurrentPersons()).forEach(([key, name]) => {
                const tag = document.createElement('div');
                tag.className = 'person-tag editable';
                tag.innerHTML = `
                    <span>${key === 'you' ? `${name} (you)` : name}</span>
                    <button onclick="editPerson('${key}')" style="background:none;border:none;cursor:pointer;">✏️</button>
                `;
                container.appendChild(tag);
            });
        }

        function moveMessage(messageIndex, direction) {
            const currentMessages = chats[currentChatIndex].messages;
            const newIndex = messageIndex + direction;
            
            if (newIndex >= 0 && newIndex < currentMessages.length) {
                [currentMessages[messageIndex], currentMessages[newIndex]] = [currentMessages[newIndex], currentMessages[messageIndex]];
                updatePreview();
                saveToLocalStorage();
            }
        }

        function editMessage(messageIndex) {
            const message = chats[currentChatIndex].messages[messageIndex];
            
            document.getElementById('messageText').value = message.text || '';
            document.getElementById('messageSender').value = message.sender;
            document.getElementById('messageTime').value = message.time || '';
            document.getElementById('messageDate').value = message.date || '';
            
            editingMessageIndex = messageIndex;
            document.getElementById('postBtn').textContent = 'Update';
            
            scrollToMessageForm();
        }

        function addComment() {
            document.getElementById('messageSender').value = 'comment';
            scrollToMessageForm();
        }

        async function addMessage() {
            const text = sanitizeInput(document.getElementById('messageText').value.trim());
            const sender = sanitizeInput(document.getElementById('messageSender').value);
            const time = sanitizeInput(document.getElementById('messageTime').value);
            const date = sanitizeInput(document.getElementById('messageDate').value);
            const imageInput = document.getElementById('messageImage');
            
            if (!text && !imageInput.files[0]) return;
            
            setLoading('postBtn', true);
            
            try {
                const message = {
                    id: editingMessageIndex >= 0 ? chats[currentChatIndex].messages[editingMessageIndex].id : generateMessageId(),
                    text,
                    sender,
                    time,
                    date,
                    image: null
                };
                
                // Handle image upload
                if (imageInput.files[0]) {
                    try {
                        const imageUrl = await uploadFile(imageInput.files[0]);
                        message.image = imageUrl;
                    } catch (error) {
                        showAlert('Fehler beim Hochladen des Bildes');
                        setLoading('postBtn', false);
                        return;
                    }
                }
                
                if (editingMessageIndex >= 0) {
                    // Update existing message
                    chats[currentChatIndex].messages[editingMessageIndex] = message;
                    editingMessageIndex = -1;
                    document.getElementById('postBtn').textContent = 'Post';
                } else {
                    // Add new message
                chats[currentChatIndex].messages.push(message);
                }
                
                updatePreview();
                saveToLocalStorage();
                
                // Clear form (except title)
                document.getElementById('messageText').value = '';
                document.getElementById('messageTime').value = '';
                document.getElementById('messageDate').value = '';
                imageInput.value = '';
                
                // Reset sender to first non-comment option
                const senderSelect = document.getElementById('messageSender');
                senderSelect.value = 'you';
                
                // Scroll to new message
                setTimeout(scrollToBottom, 100);
                
            } catch (error) {
                showAlert('Fehler beim Hinzufügen der Nachricht');
                console.error('Add message error:', error);
            } finally {
                setLoading('postBtn', false);
            }
        }

        function generateMessageId() {
            return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function updatePreview() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            // Get current title from input field for live preview
            const currentTitle = sanitizeInput(document.getElementById('chatTitle').value.trim());
            chats[currentChatIndex].title = currentTitle;
            
            chats.forEach((chat, chatIndex) => {
                if (chatIndex > 0 || chat.title) {
                    const title = document.createElement('div');
                    title.className = `chat-title ${chatIndex === currentChatIndex ? 'active' : ''}`;
                    title.textContent = chat.title || `Chat ${chatIndex + 1}`;
                    title.onclick = () => switchToChat(chatIndex);
                    container.appendChild(title);
                }
                
                if (chatIndex === currentChatIndex || chatIndex < currentChatIndex) {
                    chat.messages.forEach((message, messageIndex) => {
                    const messageDiv = document.createElement('div');
                        const messageClass = message.sender === 'comment' ? 'comment' : (message.sender === 'you' ? 'right' : 'left');
                        messageDiv.className = `message ${messageClass}`;
                        
                        // Add message controls for current chat
                        if (chatIndex === currentChatIndex) {
                            const controls = document.createElement('div');
                            controls.className = 'message-controls';
                            controls.innerHTML = `
                                <button class="message-control-btn" onclick="moveMessage(${messageIndex}, -1)" ${messageIndex === 0 ? 'disabled' : ''}>↑</button>
                                <button class="message-control-btn" onclick="moveMessage(${messageIndex}, 1)" ${messageIndex === chat.messages.length - 1 ? 'disabled' : ''}>↓</button>
                                <button class="message-control-btn" onclick="editMessage(${messageIndex})">✏️</button>
                            `;
                            messageDiv.appendChild(controls);
                        }
                    
                    // Add sender name if enabled (but not for comments)
                    if (chat.showNames && message.sender !== 'comment') {
                        const senderDiv = document.createElement('div');
                        senderDiv.className = 'message-sender';
                        senderDiv.textContent = chat.persons[message.sender] || message.sender;
                        messageDiv.appendChild(senderDiv);
                    }
                    
                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble';
                    
                    if (message.text) {
                        const textDiv = document.createElement('div');
                        textDiv.textContent = message.text;
                        bubble.appendChild(textDiv);
                    }
                    
                    if (message.image) {
                        const img = document.createElement('img');
                        img.src = message.image;
                        img.className = 'message-image';
                        bubble.appendChild(img);
                    }
                    
                    if (message.time || message.date) {
                        const info = document.createElement('div');
                        info.className = 'message-info';
                        const timeStr = message.time ? message.time : '';
                        const dateStr = message.date ? message.date : '';
                        info.textContent = `${dateStr} ${timeStr}`.trim();
                        bubble.appendChild(info);
                    }
                    
                    messageDiv.appendChild(bubble);
                    container.appendChild(messageDiv);
                });
                }
            });
        }

        function addNewChat() {
            saveCurrentChatState();
            
            const newChatNumber = chats.length + 1;
            const newChatTitle = `Chat ${newChatNumber}`;
            
            chats.push({ 
                title: newChatTitle, 
                messages: [], 
                persons: { ...getCurrentPersons() }, // Copy current persons
                showNames: false
            });
            currentChatIndex = chats.length - 1;
            
            document.getElementById('chatTitle').value = newChatTitle;
            updateCurrentChatUI();
            updatePreview();
            saveToLocalStorage();
            
            document.getElementById('chatTitle').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('chatTitle').focus();
        }

        function toggleShareOptions() {
            const options = document.getElementById('shareOptions');
            const isActive = options.classList.toggle('active');
            
            if (isActive) {
                setTimeout(() => options.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            }
        }

        function generateRandomString(length) {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function shareChat() {
            const expiry = document.getElementById('shareExpiry').value;
            const views = document.getElementById('shareViews').value;
            const password = sanitizeInput(document.getElementById('sharePassword').value);
            const isOngoing = document.getElementById('ongoingCheckbox').checked;
            
            if (chats.every(chat => chat.messages.length === 0)) {
                showAlert('Bitte füge mindestens eine Nachricht hinzu');
                return;
            }
            
            setLoading('shareBtn', true);
            
            try {
                // Save current state
                saveCurrentChatState();
                
                const chatData = {
                    chats,
                    expiry,
                    views,
                    password: password || null,
                    theme: isMonochrom ? 'monochrom' : 'gradient',
                    isOngoing
                };
                
                const response = await fetch('/api/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(chatData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Sharing failed');
                }
                
                const result = await response.json();
                const fullUrl = `${window.location.origin}${result.url}`;
                
                document.getElementById('shareLink').value = fullUrl;
                document.getElementById('shareResult').style.display = 'block';
                
                // Generate edit link
                const editUrl = generateRandomString(12);
                const editPassword = generateRandomString(6);
                const editData = {
                    chats,
                    expiry: '2days', // Always 2 days for edit links unless ongoing
                    views: 'unlimited',
                    password: editPassword,
                    theme: isMonochrom ? 'monochrom' : 'gradient',
                    isEditLink: true,
                    customUrl: editUrl,
                    isOngoing
                };
                
                const editResponse = await fetch('/api/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(editData)
                });
                
                if (editResponse.ok) {
                    const editFullUrl = `${window.location.origin}/edit/${editUrl}`;
                    const currentTitle = chats[0].title || 'Unnamed Chat';
                    const expiryDate = new Date();
                    if (isOngoing) {
                        expiryDate.setDate(expiryDate.getDate() + 90); // 3 months for ongoing
                    } else {
                    expiryDate.setDate(expiryDate.getDate() + 2);
                    }
                    
                    document.getElementById('editChatTitle').textContent = currentTitle;
                    document.getElementById('editLink').textContent = editFullUrl;
                    document.getElementById('editPassword').textContent = editPassword;
                    document.getElementById('editExpiry').textContent = expiryDate.toLocaleDateString('de-DE');
                    document.getElementById('editLinkInfo').classList.add('active');
                }
                
                showAlert(isOngoing ? 'Ongoing Tea erfolgreich erstellt!' : 'Link erfolgreich erstellt!', 'success');
                
                // Scroll to results
                setTimeout(() => {
                    document.getElementById('shareResult').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 200);
                
                // Clear local storage after successful share
                clearLocalStorage();
                
            } catch (error) {
                showAlert('Fehler beim Erstellen des Links: ' + error.message);
                console.error('Share error:', error);
            } finally {
                setLoading('shareBtn', false);
            }
        }

        async function updateTea() {
            if (!currentEditUrl || !currentEditPassword) {
                showAlert('Update nicht möglich: Kein Edit-Link aktiv');
                return;
            }

            const expiry = document.getElementById('ongoingExpiry').value;
            const views = document.getElementById('ongoingViews').value;
            
            setLoading('updateBtn', true);
            
            try {
                const response = await fetch(`/api/update/${currentEditUrl}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        expiry,
                        views,
                        password: currentEditPassword
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Update failed');
                }
                
                showAlert('Tea erfolgreich aktualisiert!', 'success');
                
            } catch (error) {
                showAlert('Fehler beim Aktualisieren: ' + error.message);
                console.error('Update error:', error);
            } finally {
                setLoading('updateBtn', false);
            }
        }

        function copyToClipboard(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            document.execCommand('copy');
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Kopiert! ✓';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        function copyEditInfo() {
            const title = document.getElementById('editChatTitle').textContent;
            const link = document.getElementById('editLink').textContent;
            const password = document.getElementById('editPassword').textContent;
            const expiry = document.getElementById('editExpiry').textContent;
            
            const text = `Chat: ${title}\nEdit Link: ${link}\nPasswort: ${password}\nLäuft ab: ${expiry}`;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Kopiert! ✓';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function startNewTea() {
            const message = isEditMode ? 
                'Alle ungespeicherten Änderungen gehen verloren. Möchtest du mit einem neuen Chat beginnen?' :
                'Alle bisherigen Chats gehen verloren. Möchtest du mit einem neuen Chat beginnen?';
                
            if (confirm(message)) {
                // Komplett zurücksetzen
                clearLocalStorage();
                
                // State zurücksetzen
                chats = [{ title: '', messages: [], persons: { you: 'Du', them: 'Them' }, showNames: false }];
                currentChatIndex = 0;
                editingMessageIndex = -1;
                isEditMode = false;
                isOngoingMode = false;
                currentEditUrl = null;
                currentEditPassword = null;
                
                // UI zurücksetzen
                document.getElementById('chatTitle').value = '';
                document.getElementById('messageText').value = '';
                document.getElementById('messageTime').value = '';
                document.getElementById('messageDate').value = '';
                document.getElementById('messageImage').value = '';
                document.getElementById('showNamesToggle').checked = false;
                document.getElementById('postBtn').textContent = 'Post';
                
                // Share Options schließen
                document.getElementById('shareOptions').classList.remove('active', 'ongoing-mode');
                document.getElementById('shareResult').style.display = 'none';
                document.getElementById('editLinkInfo').classList.remove('active');
                document.getElementById('editNotice').style.display = 'none';
            
                // Alerts leeren
                document.getElementById('alerts').innerHTML = '';
                
                // UI neu aufbauen
                updateCurrentChatUI();
                updatePreview();
                // Nach oben scrollen
                window.scrollTo(0, 0);
                
                console.log('🆕 New Tea started - all data cleared');
            }
        }

        // Auto-save before page unload
        window.addEventListener('beforeunload', () => {
            if (!isEditMode) {
            saveCurrentChatState();
            saveToLocalStorage();
            }
        });
    </script>
</body>
</html>